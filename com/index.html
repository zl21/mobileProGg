<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>mobilePro</title>
    <link rel="stylesheet" href="css/reset.css">
    <link rel="stylesheet" href="css/index.css">
</head>

<body>
    <div class="wrapper">
        <!-- 
            头部part：
            头部需要保持当前位置一直不变，所以需要用到固定定位，此固定定位参照布局视口，然而由于移动端有许多视口（ios iframe内的fixed会失效），所以通常不采用固定定位，而是使用absolute定位来模拟fixed定位。
         -->
        <div class="header">
            <div class="header_top">
                <!-- logo -->
                <h1 class="logo">
                    <a href="javascript:; ">
                        <img src="images/logo.png" alt="logo">
                    </a>
                </h1>
                <!-- 面包屑导航 -->
                <a href="javascript:;" class="menuBtn"></a>
                <!-- 三个按钮的按钮组 -->
                <div class="btns">
                    <a href="javascript:;" class="search">search</a>
                    <a href="javascript:;">sign-in</a>
                    <a href="###">sign-up</a>
                </div>
            </div>
            <div class="header_bottom">
                <form action="###" method="get">
                    <input type="text" placeholder="Don't touch me！">
                    <input type="submit" value="search">
                </form>
            </div>
            <!-- 蒙版部分(menuBtn展开) -->
            <ul class="mask">
                <li>
                    <a href="###">首页</a>
                </li>
                <li>
                    <a href="###">MV</a>
                </li>
                <li>
                    <a href="###">悦单</a>
                </li>
                <li>
                    <a href="###">V榜</a>
                </li>
                <li>
                    <a href="###">音乐</a>
                </li>
                <li>
                    <a href="###">商城</a>
                </li>
                <li>
                    <a href="###">节目</a>
                </li>
                <li>
                    <a href="###">饭团</a>
                </li>
                <li>
                    <a href="###">咨询</a>
                </li>
                <li>
                    <a href="###">娱乐</a>
                </li>
                <li>
                    <a href="###">APP</a>
                </li>
                <li>
                    <a href="###">升级</a>
                </li>
            </ul>
        </div>
        <div class="main">
            <nav class="nav">
                <ul class="list">
                    <li class="active">
                        <a href="###">首页</a>
                    </li>
                    <li>
                        <a href="###">MV</a>
                    </li>
                    <li>
                        <a href="###">悦单</a>
                    </li>
                    <li>
                        <a href="###">V榜</a>
                    </li>
                    <li>
                        <a href="###">音乐</a>
                    </li>
                    <li>
                        <a href="###">商城</a>
                    </li>
                    <li>
                        <a href="###">节目</a>
                    </li>
                    <li>
                        <a href="###">饭团</a>
                    </li>
                    <li>
                        <a href="###">咨询</a>
                    </li>
                    <li>
                        <a href="###">更新</a>
                    </li>
                    <li>
                        <a href="###">APP</a>
                    </li>
                    <li>
                        <a href="###">影视</a>
                    </li>
                    <li>
                        <a href="###">电影</a>
                    </li>
                    <li>
                        <a href="###">喜欢</a>
                    </li>
                    <li>
                        <a href="###">推荐</a>
                    </li>
                    <li>
                        <a href="###">收藏</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>

    <!-- 引入适配方案 -->
    <script src="js/rem.js"></script>
    <!-- 引入tools -->
    <script src="js/tools.js"></script>

    <script>
        // 1.阻止默认事件
        document.addEventListener("touchstart", function (ev) {
            ev.preventDefault();
        }, { passive: false });

        // 2.面包屑导航
        menuBtn();
        function menuBtn() {
            let oMenuBtn = document.querySelector(".wrapper .header .header_top .menuBtn");
            let oMask = document.querySelector(".wrapper .header .mask");

            //保存当前蒙版的状态
            let isOpen = false;

            //给按钮绑定点击事件
            oMenuBtn.addEventListener("touchstart", function (ev) {
                // 防止点击menuBtn时时间冒泡到document上从而执行document的绑定事件以至于蒙版不会被打开。
                ev.stopPropagation();

                // 阻止传播以后，就无法使用document上的阻止默认事件了,所以自身要书写也一个阻止默认事件
                ev.preventDefault();

                if (isOpen) {
                    //关闭
                    oMask.style.display = "none";
                    this.classList.remove("active");
                } else {
                    //打开
                    oMask.style.display = "block";
                    this.classList.add("active");
                }
                // 状态改变之后，开关要取反
                isOpen = !isOpen;
            });

            // 当点击页面其他位置的时候，关闭并改变开关的状态
            document.addEventListener("touchstart", function () {
                // 在其他位置点击的时候，如果开关是打开的则关闭，否则不做操作
                if (isOpen) {
                    oMask.style.display = "none";
                    oMenuBtn.classList.remove("active");
                    isOpen = !isOpen;
                }
            }, { passive: false });

            // 点击蒙版时不能让蒙版消失(奇怪的需求)，所以给蒙版也绑定一个点击事件，阻止传播
            oMask.addEventListener("touchstart", function (ev) {
                ev.stopPropagation();
                // 阻止传播后，在蒙版上就无法阻止默认事件了，所以需要手动阻止默认事件
                ev.preventDefault();
            }, { passive: false });
        }

        // 3.搜索栏获取焦点和失去焦点
        changeFoucs();
        function changeFoucs() {
            let oInputSearch = document.querySelector(".wrapper .header .header_bottom form input[type=text]");
            //点击输入框时输入框获取焦点
            oInputSearch.addEventListener("touchstart", function (ev) {
                this.focus();

                //因为会传播到document点击失去焦点的事件上，所以需要阻止传播
                ev.stopPropagation();
                //如果阻止传播以后，可能会有自身的默认事件，需要阻止默认事件
                ev.preventDefault();
            }, { passive: false });

            //点击其他位置时输入框失去焦点
            document.addEventListener("touchstart", function () {
                oInputSearch.blur();
            }, { passive: false })
        }

        // 4.拖动导航栏效果
        drag();
        function drag() {
            let oNav = document.querySelector(".wrapper .main .nav");
            let oList = document.querySelector(".wrapper .main .nav .list");
            let startX = 0;//初始化当前手开始点击的位置
            let elementX = 0;//初始化当前元素的位置
            let translateX = 0;//初始化元素应该最终的位置
            let minX = oNav.offsetWidth - oList.offsetWidth;//定义一个拖动的临界值
            /* list元素的宽度是想由内部的元素撑开的,而不是继承父元素的100%,所以：
                可：<ul class="list" style="position: absolute;">
                也可：<ul class="list" style="float: left;">
             */
            console.log(minX);
            
            //给nav一个按下事件（想要滑动，首先要按下）
            oNav.addEventListener("touchstart", function (ev) {
                //获取当前事件的touch，touchList的内容
                let touch = ev.changedTouches[0];
                //获取当前手指的位置
                startX = touch.clientX;
                //获取元素现在的位置信息（我们设计使用tanslate来进行位移）
                elementX = tools1.css(oList, "translateX");
            }, { passive: false });

            oNav.addEventListener("touchmove", function (ev) {
                //获取当前事件的手指头 touchList的内容
                let touch = ev.changedTouches[0];
                //获取当前手指头的位置
                let nowX = touch.clientX;
                //计算差值（如向左拖则disX为负）
                let disX = nowX - startX;//动手后手的位置nowX - 初放手的位置startX
                //给元素的最终位置赋值
                translateX = elementX + disX;
                /* 使得元素每次的有效移动距离都小于上一次，通过乘以一个递减的比例。
                    得出最终位置以后，判断临界值,橡皮筋效果是在临界值设置的,在move的过程中，手指移动的距离正常，但是每一次元素移动的有效距离慢慢变少,虽然每次移动的距离慢慢变少，但是元素也是在走。 
                */
                if (translateX >= 0 ) {
                    //设置一个递减的比例，比例初始值还不能大于1
                    let scale = 300 / (300 + translateX);
                    //计算好比例以后，重新对tranlateX赋值，手指走的差值乘以比例，加上元素原始的位置值
                    translateX =  disX * scale + elementX;//(如向左拖时，负小数+elementX = 向左稍微多走一点点)
                } else if (translateX <= minX) {
                    let scale = 300 / (300 + translateX);
                    translateX =  - disX * scale + elementX;
                }
                //给元素赋值最终位置
                tools1.css(oList, "translateX", translateX);
            }, { passive: false });

            //橡皮筋效果：松手后 弹回去
            oNav.addEventListener("touchend", function () {
                //判断，如果到达临界值以后需要执行松手的内容，否则松手后不执行
                if (translateX >= 0) {
                    translateX = 0;
                } else if (translateX <= minX) {
                    translateX = minX;
                }
                oList.style.transition = "all .3s";
                tools1.css(oList, "translateX", translateX);
            });
        }
    </script>
</body>

</html>